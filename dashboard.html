<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Tab Campaign Performance Dashboard</title>
  <style>
    body {
      background-color: #2E2E2E;
      color: #FFFFFF;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .metrics-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 20px;
      flex-grow: 1;
      max-height: 200px;
    }
    .metric-box {
      background-color: #3A3A3A;
      border-radius: 10px;
      padding: 10px 20px;
      margin: 10px;
      text-align: center;
      min-width: 180px;
      max-width: 180px;
      height: 120px;
      font-size: 18px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background-color: #1A1A1A;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 2;
    }
    .tab-button {
      background-color: #4A4A4A;
      border: none;
      color: #FFFFFF;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
      transition: background-color 0.3s;
      flex: 1;
      margin: 0 5px;
      text-align: center;
    }
    .tab-button:hover {
      background-color: #5A5A5A;
    }
    .tab-button.active {
      background-color: #00CED1;
    }
    .daily-inputs {
      background-color: #3A3A3A;
      border-radius: 8px;
      padding: 20px;
      margin: 20px auto;
      max-width: 900px;
      max-height: 400px;
      overflow-y: auto;
      flex-grow: 0;
      width: 90%;
    }
    .daily-inputs table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    .daily-inputs th, .daily-inputs td {
      padding: 8px;
      text-align: center;
      border: 1px solid #4A4A4A;
    }
    .daily-inputs input {
      background-color: #4A4A4A;
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      padding: 5px;
      width: 60px;
      text-align: center;
      font-size: 14px;
    }
    .daily-inputs th {
      background-color: #2E2E2E;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .add-day-button {
      background-color: #00CED1;
      border: none;
      color: #FFFFFF;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
      margin: 10px auto;
      display: block;
      transition: background-color 0.3s;
    }
    .add-day-button:hover {
      background-color: #00B7C2;
    }
  </style>
</head>
<body>
  <div id="metrics-container" class="metrics-container">
    <div id="ctr-box" class="metric-box" style="border: 2px solid #FF4500;">
      <div>Clicks: <span id="cumulativeClicks">0</span></div>
      <div>CPC: <span id="cumulativeCPC">$0.0</span></div>
      <div>CTR: <span id="cumulativeCTR">0.0%</span></div>
    </div>
    <div id="leads-box" class="metric-box" style="border: 2px solid #1E90FF;">
      <div>Leads: <span id="cumulativeLeads">0</span></div>
      <div>CPL: <span id="cumulativeCPL">$0.0</span></div>
      <div>CR: <span id="cumulativeConversionRate">0.0%</span></div>
    </div>
    <div id="booked-calls-box" class="metric-box" style="border: 2px solid #FFD700;">
      <div>Booked Calls: <span id="cumulativeBookedCalls">0</span></div>
      <div>Cost: <span id="cumulativeCostPerBookedCall">$0.0</span></div>
      <div>CR: <span id="cumulativeBookingConversionRate">0.0%</span></div>
    </div>
    <div id="showed-calls-box" class="metric-box" style="border: 2px solid #00CED1;">
      <div>Showed Calls: <span id="cumulativeShowedCalls">0</span></div>
      <div>Cost: <span id="cumulativeCostPerShowedCall">$0.0</span></div>
      <div>CR: <span id="cumulativeShowRate">0.0%</span></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="openTab('tab1')">Ad 1</button>
    <button class="tab-button" onclick="openTab('tab2')">Ad 2</button>
    <button class="tab-button" onclick="openTab('tab3')">Ad 3</button>
    <button class="tab-button" onclick="openTab('tab4')">Ad 4</button>
  </div>

  <div id="tab-content-container">
    <div id="tab1" class="tab-content active">
      <div class="daily-inputs">
        <table id="tableTab1">
          <thead>
            <tr>
              <th>Date</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Total Cost ($)</th>
            </tr>
          </thead>
          <tbody id="tbodyTab1"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab1')">Add New Day</button>
      </div>
    </div>
    <div id="tab2" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab2">
          <thead>
            <tr>
              <th>Date</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Total Cost ($)</th>
            </tr>
          </thead>
          <tbody id="tbodyTab2"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab2')">Add New Day</button>
      </div>
    </div>
    <div id="tab3" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab3">
          <thead>
            <tr>
              <th>Date</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Total Cost ($)</th>
            </tr>
          </thead>
          <tbody id="tbodyTab3"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab3')">Add New Day</button>
      </div>
    </div>
    <div id="tab4" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab4">
          <thead>
            <tr>
              <th>Date</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Total Cost ($)</th>
            </tr>
          </thead>
          <tbody id="tbodyTab4"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab4')">Add New Day</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (using compat for global firebase object) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyDuD-qTPsc9cBqqNVfO0Ur4wOaZnE4L6Cg",
      authDomain: "campaigndashboard-e8b96.firebaseapp.com",
      projectId: "campaigndashboard-e8b96",
      storageBucket: "campaigndashboard-e8b96.firebasestorage.app",
      messagingSenderId: "286098174856",
      appId: "1:286098174856:web:752334f3abbb3c5c31003d"
    };

    let db;
    let isFirebaseInitialized = false;

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      isFirebaseInitialized = true;
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error.message);
      alert(`Failed to initialize Firebase: ${error.message}. The dashboard will load with limited functionality.`);
    }

    // Global variables
    let currentTab = 'tab1';
    const tabs = ['tab1', 'tab2', 'tab3', 'tab4'];

    // Initialize data (with or without Firebase)
    const defaultDays = [
      { date: 'May 1', impressions: 10000, clicks: 100, leads: 20, bookedCalls: 2, showedCalls: 1, totalCost: 200 },
      { date: 'May 2', impressions: 15000, clicks: 150, leads: 30, bookedCalls: 3, showedCalls: 2, totalCost: 300 }
    ];

    tabs.forEach(tab => {
      if (isFirebaseInitialized) {
        db.collection('tabs').doc(tab)
          .onSnapshot(doc => {
            const data = doc.data();
            if (data && data.days) {
              renderTabData(tab, data.days);
              if (tab === currentTab) {
                updateCumulative(tab);
              }
            } else {
              db.collection('tabs').doc(tab).set({ days: defaultDays })
                .catch(error => console.error(`Error setting initial data for ${tab}:`, error));
            }
          }, error => console.error(`Snapshot error for ${tab}:`, error));
      } else {
        renderTabData(tab, defaultDays);
        if (tab === currentTab) {
          updateCumulative(tab);
        }
      }
    });

    // Render table data for a tab
    function renderTabData(tab, days) {
      const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (!tbody) {
        console.error(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)} not found`);
        return;
      }
      tbody.innerHTML = '';
      days.forEach((day, index) => {
        const row = document.createElement('tr');
        const onInputHandler = isFirebaseInitialized ? `updateFirestore('${tab}', ${index})` : `updateCumulative('${tab}')`;
        row.innerHTML = `
          <td>${day.date}</td>
          <td><input type="text" id="impressionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.impressions || 0}" oninput="${onInputHandler}"></td>
          <td><input type="text" id="clicksDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.clicks || 0}" oninput="${onInputHandler}"></td>
          <td><input type="text" id="leadsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.leads || 0}" oninput="${onInputHandler}"></td>
          <td><input type="text" id="bookedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.bookedCalls || 0}" oninput="${onInputHandler}"></td>
          <td><input type="text" id="showedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.showedCalls || 0}" oninput="${onInputHandler}"></td>
          <td><input type="text" id="totalCostDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.totalCost || 0}" oninput="${onInputHandler}"></td>
        `;
        tbody.appendChild(row);
      });
    }

    // Update Firestore when an input changes
    function updateFirestore(tab, dayIndex) {
      if (!isFirebaseInitialized) return;

      const impressions = parseFloat(document.getElementById(`impressionsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const clicks = parseFloat(document.getElementById(`clicksDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const leads = parseFloat(document.getElementById(`leadsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const bookedCalls = parseFloat(document.getElementById(`bookedCallsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const showedCalls = parseFloat(document.getElementById(`showedCallsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const totalCost = parseFloat(document.getElementById(`totalCostDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;

      db.collection('tabs').doc(tab).get().then(doc => {
        if (doc.exists) {
          const days = doc.data().days;
          if (days && days[dayIndex]) {
            days[dayIndex] = {
              date: days[dayIndex].date,
              impressions,
              clicks,
              leads,
              bookedCalls,
              showedCalls,
              totalCost
            };
            db.collection('tabs').doc(tab).update({ days })
              .catch(error => console.error(`Firestore update error for ${tab}, day ${dayIndex}:`, error));
          }
        }
      }).catch(error => console.error(`Firestore get error for ${tab}:`, error));

      if (tab === currentTab) {
        updateCumulative(tab);
      }
    }

    // Add a new day
    function addNewDay(tab) {
      if (!isFirebaseInitialized) {
        const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        const rows = tbody.getElementsByTagName('tr');
        const lastDate = rows.length > 0 ? rows[rows.length - 1].cells[0].innerText : 'May 1';
        const lastDayNum = parseInt(lastDate.split(' ')[1]) || 0;
        const newDate = `May ${lastDayNum + 1}`;
        const index = rows.length;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${newDate}</td>
          <td><input type="text" id="impressionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
          <td><input type="text" id="clicksDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
          <td><input type="text" id="leadsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
          <td><input type="text" id="bookedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
          <td><input type="text" id="showedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
          <td><input type="text" id="totalCostDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" oninput="updateCumulative('${tab}')"></td>
        `;
        tbody.appendChild(row);
        updateCumulative(tab);
        return;
      }

      db.collection('tabs').doc(tab).get().then(doc => {
        if (doc.exists) {
          const days = doc.data().days || [];
          const lastDate = days.length > 0 ? days[days.length - 1].date : 'May 1';
          const lastDayNum = parseInt(lastDate.split(' ')[1]) || 0;
          const newDate = `May ${lastDayNum + 1}`;
          days.push({
            date: newDate,
            impressions: 0,
            clicks: 0,
            leads: 0,
            bookedCalls: 0,
            showedCalls: 0,
            totalCost: 0
          });
          db.collection('tabs').doc(tab).update({ days })
            .catch(error => console.error(`Error adding new day for ${tab}:`, error));
        }
      }).catch(error => console.error(`Firestore get error for addNewDay ${tab}:`, error));
    }

    // Switch tabs
    function openTab(tabName) {
      currentTab = tabName;
      const tabContents = document.getElementsByClassName('tab-content');
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
        tabButtons[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
      document.getElementsByClassName('tab-button')[tabs.indexOf(tabName)].classList.add('active');
      updateCumulative(tabName);
    }

    // Update cumulative metrics
    function updateCumulative(tab) {
      if (isFirebaseInitialized) {
        db.collection('tabs').doc(tab).get().then(doc => {
          if (doc.exists) {
            const days = doc.data().days || [];
            let totalImpressions = 0, totalClicks = 0, totalLeads = 0, totalBookedCalls = 0, totalShowedCalls = 0, totalCost = 0;

            days.forEach(day => {
              totalImpressions += day.impressions || 0;
              totalClicks += day.clicks || 0;
              totalLeads += day.leads || 0;
              totalBookedCalls += day.bookedCalls || 0;
              totalShowedCalls += day.showedCalls || 0;
              totalCost += day.totalCost || 0;
            });

            const ctr = totalImpressions ? (totalClicks / totalImpressions * 100).toFixed(1) : 0;
            const cpc = totalClicks ? (totalCost / totalClicks).toFixed(1) : 0;
            const conversionRate = totalClicks ? (totalLeads / totalClicks * 100).toFixed(1) : 0;
            const cpl = totalLeads ? (totalCost / totalLeads).toFixed(1) : 0;
            const bookingConversionRate = totalLeads ? (totalBookedCalls / totalLeads * 100).toFixed(1) : 0;
            const costPerBookedCall = totalBookedCalls ? (totalCost / totalBookedCalls).toFixed(1) : 0;
            const showRate = totalBookedCalls ? (totalShowedCalls / totalBookedCalls * 100).toFixed(1) : 0;
            const costPerShowedCall = totalShowedCalls ? (totalCost / totalShowedCalls).toFixed(1) : 0;

            document.getElementById('cumulativeClicks').innerText = totalClicks;
            document.getElementById('cumulativeCTR').innerText = `${ctr}%`;
            document.getElementById('cumulativeCPC').innerText = `$${cpc}`;
            document.getElementById('cumulativeLeads').innerText = totalLeads;
            document.getElementById('cumulativeCPL').innerText = `$${cpl}`;
            document.getElementById('cumulativeConversionRate').innerText = `${conversionRate}%`;
            document.getElementById('cumulativeBookedCalls').innerText = totalBookedCalls;
            document.getElementById('cumulativeCostPerBookedCall').innerText = `$${costPerBookedCall}`;
            document.getElementById('cumulativeBookingConversionRate').innerText = `${bookingConversionRate}%`;
            document.getElementById('cumulativeShowedCalls').innerText = totalShowedCalls;
            document.getElementById('cumulativeCostPerShowedCall').innerText = `$${costPerShowedCall}`;
            document.getElementById('cumulativeShowRate').innerText = `${showRate}%`;
          }
        }).catch(error => console.error(`Cumulative update error for ${tab}:`, error));
      } else {
        const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        const rows = tbody.getElementsByTagName('tr');
        let totalImpressions = 0, totalClicks = 0, totalLeads = 0, totalBookedCalls = 0, totalShowedCalls = 0, totalCost = 0;

        for (let i = 0; i < rows.length; i++) {
          totalImpressions += parseFloat(document.getElementById(`impressionsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalClicks += parseFloat(document.getElementById(`clicksDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalLeads += parseFloat(document.getElementById(`leadsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalBookedCalls += parseFloat(document.getElementById(`bookedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalShowedCalls += parseFloat(document.getElementById(`showedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalCost += parseFloat(document.getElementById(`totalCostDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
        }

        const ctr = totalImpressions ? (totalClicks / totalImpressions * 100).toFixed(1) : 0;
        const cpc = totalClicks ? (totalCost / totalClicks).toFixed(1) : 0;
        const conversionRate = totalClicks ? (totalLeads / totalClicks * 100).toFixed(1) : 0;
        const cpl = totalLeads ? (totalCost / totalLeads).toFixed(1) : 0;
        const bookingConversionRate = totalLeads ? (totalBookedCalls / totalLeads * 100).toFixed(1) : 0;
        const costPerBookedCall = totalBookedCalls ? (totalCost / totalBookedCalls).toFixed(1) : 0;
        const showRate = totalBookedCalls ? (totalShowedCalls / totalBookedCalls * 100).toFixed(1) : 0;
        const costPerShowedCall = totalShowedCalls ? (totalCost / totalShowedCalls).toFixed(1) : 0;

        document.getElementById('cumulativeClicks').innerText = totalClicks;
        document.getElementById('cumulativeCTR').innerText = `${ctr}%`;
        document.getElementById('cumulativeCPC').innerText = `$${cpc}`;
        document.getElementById('cumulativeLeads').innerText = totalLeads;
        document.getElementById('cumulativeCPL').innerText = `$${cpl}`;
        document.getElementById('cumulativeConversionRate').innerText = `${conversionRate}%`;
        document.getElementById('cumulativeBookedCalls').innerText = totalBookedCalls;
        document.getElementById('cumulativeCostPerBookedCall').innerText = `$${costPerBookedCall}`;
        document.getElementById('cumulativeBookingConversionRate').innerText = `${bookingConversionRate}%`;
        document.getElementById('cumulativeShowedCalls').innerText = totalShowedCalls;
        document.getElementById('cumulativeCostPerShowedCall').innerText = `$${costPerShowedCall}`;
        document.getElementById('cumulativeShowRate').innerText = `${showRate}%`;
      }
    }
  </script>
</body>
</html>
