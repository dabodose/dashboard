<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Tab Campaign Performance Dashboard</title>
  <style>
    body {
      background-color: #2E2E2E;
      color: #FFFFFF;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .home-icon {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      color: #FFFFFF;
      text-decoration: none;
      transition: color 0.3s;
    }
    .home-icon:hover {
      color: #00CED1;
    }
    .metrics-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 20px;
      flex-grow: 1;
      max-height: 200px;
    }
    .metric-box {
      background-color: #3A3A3A;
      border-radius: 10px;
      padding: 10px 20px;
      margin: 10px;
      text-align: center;
      min-width: 180px;
      max-width: 180px;
      height: 120px;
      font-size: 18px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      border: 2px solid #FFFFFF;
      display: none; /* Hidden until first entry */
    }
    #ctr-box {
      box-shadow: 0 0 10px rgba(128, 0, 128, 0.7), 0 0 20px rgba(128, 0, 128, 0.5); /* Purple glow */
    }
    #leads-box {
      box-shadow: 0 0 10px rgba(75, 0, 130, 0.7), 0 0 20px rgba(75, 0, 130, 0.5); /* Blue-Purple glow */
    }
    #booked-calls-box {
      box-shadow: 0 0 10px rgba(0, 0, 255, 0.7), 0 0 20px rgba(0, 0, 255, 0.5); /* Blue glow */
    }
    #showed-calls-box {
      box-shadow: 0 0 10px rgba(0, 206, 209, 0.7), 0 0 20px rgba(0, 206, 209, 0.5); /* Green-Blue glow */
    }
    #conversions-box {
      box-shadow: 0 0 10px rgba(0, 128, 0, 0.7), 0 0 20px rgba(0, 128, 0, 0.5); /* Green glow */
    }
    .title {
      text-align: center;
      font-size: 20px;
      margin: 10px 0;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background-color: #1A1A1A;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 2;
    }
    .tab-button {
      background-color: #4A4A4A;
      border: none;
      color: #FFFFFF;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
      transition: background-color 0.3s;
      flex: 1;
      margin: 0 5px;
      text-align: center;
    }
    .tab-button:hover {
      background-color: #5A5A5A;
    }
    .tab-button.active {
      background-color: #00CED1;
    }
    .tab-button input {
      background-color: inherit;
      border: none;
      color: #FFFFFF;
      font-size: 16px;
      width: 100%;
      text-align: center;
      padding: 0;
    }
    .daily-inputs {
      background-color: #3A3A3A;
      border-radius: 8px;
      padding: 20px;
      margin: 12px auto;
      max-width: 1200px;
      max-height: 400px;
      overflow-y: auto;
      flex-grow: 0;
      width: 90%;
      border: 2px solid #FFFFFF;
    }
    .daily-inputs table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    .daily-inputs th, .daily-inputs td {
      padding: 8px;
      text-align: center;
      border: 1px solid #4A4A4A;
      position: relative;
      height: 40px;
      box-sizing: border-box;
    }
    .daily-inputs th:nth-child(11), .daily-inputs td:nth-child(11) {
      width: 150px;
    }
    .daily-inputs input {
      background-color: #4A4A4A;
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      padding: 5px;
      width: 60px;
      text-align: center;
      font-size: 14px;
      height: 24px;
      box-sizing: border-box;
    }
    .daily-inputs input.date-input {
      width: 80px;
    }
    .daily-inputs th {
      background-color: #2E2E2E;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .daily-inputs .calculated {
      background-color: #2E2E2E;
      color: #A0A0A0;
      cursor: default;
    }
    .derived-line {
      border: none;
      border-top: 2px solid #FFFFFF;
      width: 70%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
    }
    .delete-btn {
      background-color: #FF4500;
      border: none;
      color: #FFFFFF;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 3px;
      transition: background-color 0.3s;
      display: none; /* Hidden by default */
    }
    .delete-btn:hover {
      background-color: #FF6347;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .add-day-button {
      background-color: #00CED1;
      border: none;
      color: #FFFFFF;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
      margin: 10px auto;
      display: block;
      transition: background-color 0.3s;
    }
    .add-day-button:hover {
      background-color: #00B7C2;
    }
  </style>
</head>
<body>
  <a href="https://dashboard-projectlegacy.vercel.app/setup.html" class="home-icon">üè†</a>
  <div class="title">Cumulative Data</div>
  <div id="metrics-container" class="metrics-container">
    <div id="ctr-box" class="metric-box">
      <div>Clicks: <span id="cumulativeClicks">0</span></div>
      <div>CPC: <span id="cumulativeCPC">$0.0</span></div>
      <div>CTR: <span id="cumulativeCTR">0.0%</span></div>
    </div>
    <div id="leads-box" class="metric-box">
      <div>Leads: <span id="cumulativeLeads">0</span></div>
      <div>CPL: <span id="cumulativeCPL">$0.0</span></div>
      <div>CR: <span id="cumulativeConversionRate">0.0%</span></div>
    </div>
    <div id="booked-calls-box" class="metric-box">
      <div>Booked Calls: <span id="cumulativeBookedCalls">0</span></div>
      <div>Cost: <span id="cumulativeCostPerBookedCall">$0.0</span></div>
      <div>CR: <span id="cumulativeBookingConversionRate">0.0%</span></div>
    </div>
    <div id="showed-calls-box" class="metric-box">
      <div>Showed Calls: <span id="cumulativeShowedCalls">0</span></div>
      <div>Cost: <span id="cumulativeCostPerShowedCall">$0.0</span></div>
      <div>CR: <span id="cumulativeShowRate">0.0%</span></div>
    </div>
    <div id="conversions-box" class="metric-box">
      <div>Sales: <span id="cumulativeConversions">0</span></div>
      <div>Cost: <span id="cumulativeCostPerConversion">$0.0</span></div>
      <div>CR: <span id="cumulativeConversionCR">0.0%</span></div>
    </div>
  </div>
  <div class="title">Daily Data</div>
  <div class="tabs">
    <div class="tab-button active" onclick="openTab('tab1')">
      <input type="text" id="tabName1" value="Tab 1" onchange="updateTabName('tab1')">
    </div>
    <div class="tab-button" onclick="openTab('tab2')">
      <input type="text" id="tabName2" value="Tab 2" onchange="updateTabName('tab2')">
    </div>
    <div class="tab-button" onclick="openTab('tab3')">
      <input type="text" id="tabName3" value="Tab 3" onchange="updateTabName('tab3')">
    </div>
    <div class="tab-button" onclick="openTab('tab4')">
      <input type="text" id="tabName4" value="Tab 4" onchange="updateTabName('tab4')">
    </div>
  </div>

  <div id="tab-content-container">
    <div id="tab1" class="tab-content active">
      <div class="daily-inputs">
        <table id="tableTab1">
          <thead>
            <tr>
              <th>Date</th>
              <th>Cost ($)</th>
              <th>CPM</th>
              <th>Imp.</th>
              <th>CTR</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Sales</th>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyTab1"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab1')">Add New Day</button>
      </div>
    </div>
    <div id="tab2" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab2">
          <thead>
            <tr>
              <th>Date</th>
              <th>Cost ($)</th>
              <th>CPM</th>
              <th>Imp.</th>
              <th>CTR</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Sales</th>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyTab2"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab2')">Add New Day</button>
      </div>
    </div>
    <div id="tab3" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab3">
          <thead>
            <tr>
              <th>Date</th>
              <th>Cost ($)</th>
              <th>CPM</th>
              <th>Imp.</th>
              <th>CTR</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Sales</th>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyTab3"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab3')">Add New Day</button>
      </div>
    </div>
    <div id="tab4" class="tab-content">
      <div class="daily-inputs">
        <table id="tableTab4">
          <thead>
            <tr>
              <th>Date</th>
              <th>Cost ($)</th>
              <th>CPM</th>
              <th>Imp.</th>
              <th>CTR</th>
              <th>Clicks</th>
              <th>Leads</th>
              <th>Booked Calls</th>
              <th>Showed Calls</th>
              <th>Sales</th>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyTab4"></tbody>
        </table>
        <button class="add-day-button" onclick="addNewDay('tab4')">Add New Day</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (using compat for global firebase object) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyDuD-qTPsc9cBqqNVfO0Ur4wOaZnE4L6Cg",
      authDomain: "campaigndashboard-e8b96.firebaseapp.com",
      projectId: "campaigndashboard-e8b96",
      storageBucket: "campaigndashboard-e8b96.firebasestorage.app",
      messagingSenderId: "286098174856",
      appId: "1:286098174856:web:752334f3abbb3c5c31003d"
    };

    let db;
    let isFirebaseInitialized = false;
    let username;

    // Global variables (moved to the top)
    let currentTab = 'tab1';
    const tabs = ['tab1', 'tab2', 'tab3', 'tab4'];

    // Get the current date in "Month Day" format (e.g., "May 27")
    const today = new Date();
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const currentDate = `${monthNames[today.getMonth()]} ${today.getDate()}`;

    // Initialize data (with or without Firebase)
    const defaultDays = [
      { date: currentDate, cost: 0, impressions: 0, clicks: 0, leads: 0, bookedCalls: 0, showedCalls: 0, conversions: 0, name: "", extraRows: [] }
    ];

    // Firebase initialization
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      isFirebaseInitialized = true;
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error.message);
      alert(`Failed to initialize Firebase: ${error.message}. The dashboard will load with limited functionality.`);
    }

    // Get username from query parameter and load dashboard
    const urlParams = new URLSearchParams(window.location.search);
    username = urlParams.get('username') || 'defaultUser';
    if (!urlParams.get('username')) {
      alert('No username provided. Using defaultUser. Please access this dashboard with a username parameter.');
    } else {
      // Automatically initialize and load the dashboard
      initializeDashboard();
    }

    function initializeDashboard() {
      if (isFirebaseInitialized) {
        // Load tab data and names with pre-initialization
        tabs.forEach(tab => {
          db.collection('users').doc(username).collection('tabs').doc(tab).get()
            .then(doc => {
              if (!doc.exists) {
                const defaultData = { days: defaultDays, tabNames: { [tab]: `Tab ${tabs.indexOf(tab) + 1}` } };
                return db.collection('users').doc(username).collection('tabs').doc(tab)
                  .set(defaultData)
                  .then(() => {
                    console.log(`Initialized default data for ${username}/${tab}`);
                    renderTabData(tab, defaultDays);
                    document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = defaultData.tabNames[tab];
                    if (tab === currentTab) {
                      updateCumulative(tab);
                    }
                  })
                  .catch(error => console.error(`Error setting initial data for ${username}/${tab}:`, error));
              } else {
                const data = doc.data();
                if (data && data.days) {
                  renderTabData(tab, data.days);
                }
                if (data && data.tabNames && data.tabNames[tab]) {
                  document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = data.tabNames[tab];
                } else {
                  document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = `Tab ${tabs.indexOf(tab) + 1}`;
                }
                if (tab === currentTab) {
                  updateCumulative(tab);
                }
              }
            })
            .then(() => {
              // Set up real-time listener
              return db.collection('users').doc(username).collection('tabs').doc(tab)
                .onSnapshot(doc => {
                  const data = doc.data();
                  if (data && data.days) {
                    renderTabData(tab, data.days);
                  }
                  if (data && data.tabNames && data.tabNames[tab]) {
                    document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = data.tabNames[tab];
                  }
                  if (tab === currentTab) {
                    updateCumulative(tab);
                  }
                }, error => {
                  console.error(`Snapshot error for ${username}/${tab}:`, error);
                  renderTabData(tab, defaultDays);
                  document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = `Tab ${tabs.indexOf(tab) + 1}`;
                  if (tab === currentTab) {
                    updateCumulative(tab);
                  }
                });
            })
            .catch(error => console.error(`Error setting up tab data listener for ${username}/${tab}:`, error));
        });
      } else {
        tabs.forEach(tab => {
          renderTabData(tab, defaultDays);
          document.getElementById(`tabName${tabs.indexOf(tab) + 1}`).value = `Tab ${tabs.indexOf(tab) + 1}`;
          if (tab === currentTab) {
            updateCumulative(tab);
          }
        });
      }
    }

    // Update tab name and save to Firebase
    function updateTabName(tab) {
      const tabIndex = tabs.indexOf(tab) + 1;
      const input = document.getElementById(`tabName${tabIndex}`);
      const newName = input.value.trim() || `Tab ${tabIndex}`;
      input.value = newName;

      if (isFirebaseInitialized) {
        db.collection('users').doc(username).collection('tabs').doc(tab).get()
          .then(doc => {
            const data = doc.exists ? doc.data() : { days: defaultDays, tabNames: {} };
            data.tabNames = data.tabNames || {};
            data.tabNames[tab] = newName;
            return db.collection('users').doc(username).collection('tabs').doc(tab)
              .set(data, { merge: true })
              .catch(error => console.error(`Error updating tab name for ${username}/${tab}:`, error));
          })
          .catch(error => console.error(`Error fetching tab data for ${username}/${tab}:`, error));
      }
    }

    // Render table data for a tab
    function renderTabData(tab, days) {
      const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (!tbody) {
        console.error(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)} not found`);
        return;
      }
      tbody.innerHTML = '';
      days.forEach((day, index) => {
        const row = document.createElement('tr');
        const cpm = day.impressions ? ((day.cost / day.impressions) * 1000).toFixed(2) : '‚Äî';
        const ctr = day.impressions ? ((day.clicks / day.impressions) * 100).toFixed(2) : '‚Äî';
        const onChangeHandler = isFirebaseInitialized ? `updateFirestore('${tab}', ${index})` : `updateCumulative('${tab}')`;
        const nameDisabled = day.bookedCalls === 0;
        const nameValue = day.bookedCalls === 0 ? '' : (day.name || '');
        const isEmpty = !day.cost && !day.impressions && !day.clicks && !day.leads && !day.bookedCalls && !day.showedCalls && !day.conversions && !day.name;
        row.innerHTML = `
          <td><input type="text" class="date-input" id="dateDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.date}" onchange="${onChangeHandler}"></td>
          <td><input type="text" id="costDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.cost || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" class="calculated" readonly value="${cpm}"></td>
          <td><input type="text" id="impressionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.impressions || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" class="calculated" readonly value="${ctr}"></td>
          <td><input type="text" id="clicksDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.clicks || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" id="leadsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.leads || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" id="bookedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.bookedCalls || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" id="showedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.showedCalls || 0}" onchange="${onChangeHandler}"></td>
          <td><input type="text" id="conversionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${day.conversions || 0}" onchange="${onChangeHandler}"></td>
          <td>
            ${nameDisabled ? '‚Äî' : `
              <input type="text" id="nameDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${nameValue}" onchange="${onChangeHandler}">
            `}
          </td>
          <td><button class="delete-btn" onclick="deleteRow('${tab}', ${index})" style="${isEmpty ? 'display: inline;' : 'display: none;'}">X</button></td>
        `;
        tbody.appendChild(row);

        // Handle additional rows for Booked Calls > 1
        if (day.bookedCalls > 1) {
          for (let i = 1; i < day.bookedCalls; i++) {
            const extraRow = document.createElement('tr');
            const extraData = day.extraRows && day.extraRows[i - 1] ? day.extraRows[i - 1] : { showedCalls: 0, conversions: 0, name: '' };
            extraRow.innerHTML = `
              <td><hr class="derived-line"></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td><input type="text" id="extraShowedCallsDay${index + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${extraData.showedCalls || 0}" onchange="${onChangeHandler}"></td>
              <td><input type="text" id="extraConversionsDay${index + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${extraData.conversions || 0}" onchange="${onChangeHandler}"></td>
              <td>
                <input type="text" id="extraNameDay${index + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${extraData.name || ''}" onchange="${onChangeHandler}">
              </td>
              <td></td>
            `;
            tbody.appendChild(extraRow);
          }
        }
      });
    }

    // Update Firestore when an input changes
    function updateFirestore(tab, dayIndex) {
      if (!isFirebaseInitialized) return;

      const date = document.getElementById(`dateDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value;
      const cost = parseFloat(document.getElementById(`costDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const impressions = parseFloat(document.getElementById(`impressionsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const clicks = parseFloat(document.getElementById(`clicksDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const leads = parseFloat(document.getElementById(`leadsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const bookedCalls = parseFloat(document.getElementById(`bookedCallsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const showedCalls = parseFloat(document.getElementById(`showedCallsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const conversions = parseFloat(document.getElementById(`conversionsDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
      const name = bookedCalls === 0 ? '' : (document.getElementById(`nameDay${dayIndex + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value || '');

      db.collection('users').doc(username).collection('tabs').doc(tab).get().then(doc => {
        if (doc.exists) {
          const days = doc.data().days;
          if (days && days[dayIndex]) {
            days[dayIndex] = {
              date: date,
              cost: cost,
              impressions: impressions,
              clicks: clicks,
              leads: leads,
              bookedCalls: bookedCalls,
              showedCalls: showedCalls,
              conversions: conversions,
              name: bookedCalls >= 1 ? name : "",
              extraRows: days[dayIndex].extraRows || []
            };

            if (bookedCalls <= 1) {
              days[dayIndex].extraRows = [];
            } else {
              const newExtraRows = [];
              for (let i = 1; i < bookedCalls; i++) {
                const extraShowedCalls = parseFloat(document.getElementById(`extraShowedCallsDay${dayIndex + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value) || 0;
                const extraConversions = parseFloat(document.getElementById(`extraConversionsDay${dayIndex + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value) || 0;
                const extraName = document.getElementById(`extraNameDay${dayIndex + 1}_${i}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value || '';
                newExtraRows[i - 1] = {
                  showedCalls: extraShowedCalls,
                  conversions: extraConversions,
                  name: extraName
                };
              }
              days[dayIndex].extraRows = newExtraRows;
            }

            db.collection('users').doc(username).collection('tabs').doc(tab).update({ days })
              .catch(error => console.error(`Firestore update error for ${username}/${tab}, day ${dayIndex}:`, error));
          }
        }
      }).catch(error => console.error(`Firestore get error for ${username}/${tab}:`, error));

      if (tab === currentTab) {
        updateCumulative(tab);
      }
    }

    // Delete a row
    function deleteRow(tab, dayIndex) {
      if (!isFirebaseInitialized) {
        const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        const rows = tbody.getElementsByTagName('tr');
        if (rows[dayIndex]) {
          tbody.removeChild(rows[dayIndex]);
          updateCumulative(tab);
        }
        return;
      }

      db.collection('users').doc(username).collection('tabs').doc(tab).get().then(doc => {
        if (doc.exists) {
          const days = doc.data().days || [];
          if (days[dayIndex]) {
            days.splice(dayIndex, 1);
            db.collection('users').doc(username).collection('tabs').doc(tab).update({ days })
              .catch(error => console.error(`Error deleting row for ${username}/${tab}, day ${dayIndex}:`, error));
          }
        }
      }).catch(error => console.error(`Firestore get error for deleteRow ${username}/${tab}:`, error));
    }

    // Add a new day
    function addNewDay(tab) {
      if (!isFirebaseInitialized) {
        const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        const rows = tbody.getElementsByTagName('tr');
        const lastDate = rows.length > 0 ? rows[rows.length - 1].cells[0].querySelector('input').value : currentDate;
        const [month, day] = lastDate.split(' ');
        const lastDayNum = parseInt(day) || 0;
        const newDate = `${month} ${lastDayNum + 1}`;
        const index = rows.length;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" class="date-input" id="dateDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="${newDate}" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" id="costDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" class="calculated" readonly value="‚Äî" title="Calculated as (Cost / Impressions) * 1000"></td>
          <td><input type="text" id="impressionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" class="calculated" readonly value="‚Äî" title="Calculated as (Clicks / Impressions) * 100"></td>
          <td><input type="text" id="clicksDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" id="leadsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" id="bookedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" id="showedCallsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td><input type="text" id="conversionsDay${index + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}" value="0" onchange="updateCumulative('${tab}')"></td>
          <td>‚Äî</td>
          <td><button class="delete-btn" onclick="deleteRow('${tab}', ${index})">X</button></td>
        `;
        tbody.appendChild(row);
        updateCumulative(tab);
        return;
      }

      db.collection('users').doc(username).collection('tabs').doc(tab).get()
        .then(doc => {
          const days = doc.exists ? (doc.data().days || []) : [];
          const lastDate = days.length > 0 ? days[days.length - 1].date : currentDate;
          const [month, day] = lastDate.split(' ');
          const lastDayNum = parseInt(day) || 0;
          const newDate = `${month} ${lastDayNum + 1}`;
          const newDay = {
            date: newDate,
            cost: 0,
            impressions: 0,
            clicks: 0,
            leads: 0,
            bookedCalls: 0,
            showedCalls: 0,
            conversions: 0,
            name: "",
            extraRows: []
          };
          days.push(newDay);
          return db.collection('users').doc(username).collection('tabs').doc(tab)
            .set({ days }, { merge: true })
            .then(() => {
              console.log(`Successfully added new day for ${username}/${tab}: ${newDate}`);
              renderTabData(tab, days);
              if (tab === currentTab) {
                updateCumulative(tab);
              }
            });
        })
        .catch(error => {
          console.error(`Error adding new day for ${username}/${tab}:`, error);
          alert(`Failed to add new day: ${error.message}. Please try again.`);
        });
    }

    // Switch tabs
    function openTab(tabName) {
      currentTab = tabName;
      const tabContents = document.getElementsByClassName('tab-content');
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
        tabButtons[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
      document.getElementsByClassName('tab-button')[tabs.indexOf(tabName)].classList.add('active');
      updateCumulative(tabName);
    }

    // Update cumulative metrics
    function updateCumulative(tab) {
      if (isFirebaseInitialized) {
        db.collection('users').doc(username).collection('tabs').doc(tab).get().then(doc => {
          if (doc.exists) {
            const days = doc.data().days || [];
            let totalImpressions = 0, totalClicks = 0, totalLeads = 0, totalBookedCalls = 0, totalShowedCalls = 0, totalCost = 0, totalConversions = 0;
            let hasData = false;

            days.forEach(day => {
              totalImpressions += day.impressions || 0;
              totalClicks += day.clicks || 0;
              totalLeads += day.leads || 0;
              totalBookedCalls += day.bookedCalls || 0;
              totalShowedCalls += day.showedCalls || 0;
              totalCost += day.cost || 0;
              totalConversions += day.conversions || 0;
              if (day.extraRows) {
                day.extraRows.forEach(extra => {
                  totalShowedCalls += extra.showedCalls || 0;
                  totalConversions += extra.conversions || 0;
                });
              }
              if (day.cost || day.impressions || day.clicks || day.leads || day.bookedCalls || day.showedCalls || day.conversions) {
                hasData = true;
              }
            });

            const metricBoxes = document.getElementsByClassName('metric-box');
            for (let box of metricBoxes) {
              box.style.display = hasData ? 'flex' : 'none';
            }

            const ctr = totalImpressions ? (totalClicks / totalImpressions * 100).toFixed(1) : 0;
            const cpc = totalClicks ? (totalCost / totalClicks).toFixed(1) : 0;
            const conversionRate = totalClicks ? (totalLeads / totalClicks * 100).toFixed(1) : 0;
            const cpl = totalLeads ? (totalCost / totalLeads).toFixed(1) : 0;
            const bookingConversionRate = totalLeads ? (totalBookedCalls / totalLeads * 100).toFixed(1) : 0;
            const costPerBookedCall = totalBookedCalls ? (totalCost / totalBookedCalls).toFixed(1) : 0;
            const showRate = totalBookedCalls ? (totalShowedCalls / totalBookedCalls * 100).toFixed(1) : 0;
            const costPerShowedCall = totalShowedCalls ? (totalCost / totalShowedCalls).toFixed(1) : 0;
            const costPerConversion = totalConversions ? (totalCost / totalConversions).toFixed(1) : 0;
            const conversionCR = totalBookedCalls ? (totalConversions / totalBookedCalls * 100).toFixed(1) : 0;

            document.getElementById('cumulativeClicks').innerText = totalClicks;
            document.getElementById('cumulativeCTR').innerText = `${ctr}%`;
            document.getElementById('cumulativeCPC').innerText = `$${cpc}`;
            document.getElementById('cumulativeLeads').innerText = totalLeads;
            document.getElementById('cumulativeCPL').innerText = `$${cpl}`;
            document.getElementById('cumulativeConversionRate').innerText = `${conversionRate}%`;
            document.getElementById('cumulativeBookedCalls').innerText = totalBookedCalls;
            document.getElementById('cumulativeCostPerBookedCall').innerText = `$${costPerBookedCall}`;
            document.getElementById('cumulativeBookingConversionRate').innerText = `${bookingConversionRate}%`;
            document.getElementById('cumulativeShowedCalls').innerText = totalShowedCalls;
            document.getElementById('cumulativeCostPerShowedCall').innerText = `$${costPerShowedCall}`;
            document.getElementById('cumulativeShowRate').innerText = `${showRate}%`;
            document.getElementById('cumulativeConversions').innerText = totalConversions;
            document.getElementById('cumulativeCostPerConversion').innerText = `$${costPerConversion}`;
            document.getElementById('cumulativeConversionCR').innerText = `${conversionCR}%`;
          }
        }).catch(error => console.error(`Cumulative update error for ${username}/${tab}:`, error));
      } else {
        const tbody = document.getElementById(`tbody${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        const rows = tbody.getElementsByTagName('tr');
        let totalImpressions = 0, totalClicks = 0, totalLeads = 0, totalBookedCalls = 0, totalShowedCalls = 0, totalCost = 0, totalConversions = 0;
        let hasData = false;

        for (let i = 0; i < rows.length; i++) {
          const bookedCalls = parseFloat(document.getElementById(`bookedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalImpressions += parseFloat(document.getElementById(`impressionsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalClicks += parseFloat(document.getElementById(`clicksDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalLeads += parseFloat(document.getElementById(`leadsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalBookedCalls += bookedCalls;
          totalShowedCalls += parseFloat(document.getElementById(`showedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalCost += parseFloat(document.getElementById(`costDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;
          totalConversions += parseFloat(document.getElementById(`conversionsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) || 0;

          if (document.getElementById(`costDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`impressionsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`clicksDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`leadsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`bookedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`showedCallsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value ||
              document.getElementById(`conversionsDay${i + 1}${tab.charAt(0).toUpperCase() + tab.slice(1)}`).value) {
            hasData = true;
          }

          for (let j = 1; j < bookedCalls; j++) {
            totalShowedCalls += parseFloat(document.getElementById(`extraShowedCallsDay${i + 1}_${j}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value || 0);
            totalConversions += parseFloat(document.getElementById(`extraConversionsDay${i + 1}_${j}${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.value || 0);
          }
        }

        const metricBoxes = document.getElementsByClassName('metric-box');
        for (let box of metricBoxes) {
          box.style.display = hasData ? 'flex' : 'none';
        }

        const ctr = totalImpressions ? (totalClicks / totalImpressions * 100).toFixed(1) : 0;
        const cpc = totalClicks ? (totalCost / totalClicks).toFixed(1) : 0;
        const conversionRate = totalClicks ? (totalLeads / totalClicks * 100).toFixed(1) : 0;
        const cpl = totalLeads ? (totalCost / totalLeads).toFixed(1) : 0;
        const bookingConversionRate = totalLeads ? (totalBookedCalls / totalLeads * 100).toFixed(1) : 0;
        const costPerBookedCall = totalBookedCalls ? (totalCost / totalBookedCalls).toFixed(1) : 0;
        const showRate = totalBookedCalls ? (totalShowedCalls / totalBookedCalls * 100).toFixed(1) : 0;
        const costPerShowedCall = totalShowedCalls ? (totalCost / totalShowedCalls).toFixed(1) : 0;
        const costPerConversion = totalConversions ? (totalCost / totalConversions).toFixed(1) : 0;
        const conversionCR = totalBookedCalls ? (totalConversions / totalBookedCalls * 100).toFixed(1) : 0;

        document.getElementById('cumulativeClicks').innerText = totalClicks;
        document.getElementById('cumulativeCTR').innerText = `${ctr}%`;
        document.getElementById('cumulativeCPC').innerText = `$${cpc}`;
        document.getElementById('cumulativeLeads').innerText = totalLeads;
        document.getElementById('cumulativeCPL').innerText = `$${cpl}`;
        document.getElementById('cumulativeConversionRate').innerText = `${conversionRate}%`;
        document.getElementById('cumulativeBookedCalls').innerText = totalBookedCalls;
        document.getElementById('cumulativeCostPerBookedCall').innerText = `$${costPerBookedCall}`;
        document.getElementById('cumulativeBookingConversionRate').innerText = `${bookingConversionRate}%`;
        document.getElementById('cumulativeShowedCalls').innerText = totalShowedCalls;
        document.getElementById('cumulativeCostPerShowedCall').innerText = `$${costPerShowedCall}`;
        document.getElementById('cumulativeShowRate').innerText = `${showRate}%`;
        document.getElementById('cumulativeConversions').innerText = totalConversions;
        document.getElementById('cumulativeCostPerConversion').innerText = `$${costPerConversion}`;
        document.getElementById('cumulativeConversionCR').innerText = `${conversionCR}%`;
      }
    }
  </script>
</body>
</html>
